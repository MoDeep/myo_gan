손 제스처를 이용한 임베디드 시스템 제어
=========================================


###	개요 
*	영화 '매트릭스'에서'센티널'이라는 문어 형상의 기계가 등장합니다. 영화에서는 주인공이 이 괴물들과 싸우게 되는데요, 놀라운 것은 여기서 주인공은 손의 제스처만을 이용해 센티널과 적들을 물리칩니다. 많은 사람들이 이 장면을 보고서는 "와... 저게 말이 되냐..?" 생각하실 것 같습니다. 하지만 더 생각을 해본다면 현실세게에서도 충분히 가능한 이야기 일지도 모르겠습니다. 그런 가능성을 보고 프로젝트를 진행해보았습니다.


### 내용
*	영화에서 주인공은 현실세계에서 손의 제스처만을 통해 가상세계의 적들을 공격합니다. 주인공이 현실세계에서 손의 제스처만으로도 가상세계의 적들을 물리치는 것 처럼 구현하기 위해 현실세계와 가상세게를 구분해 놓았습니다. 이 둘은 물리적으로는 아무런 관게가 없습니다. 다만 무선 통신(와이파이)으로 연결이 되어있습니다. 이것을 실제로 구현하기 위해 프로젝트의 범위를 다음과 같이 지정했습니다.
	
	*	현실세게에서 손의 제스처(모양)를 인식하고 신호를 보내주는 부분
	*	가상세계에서 현실세계에서 보내준 신호를 받고 시스템을 제어하는 부분
	

*	위의 프로젝트 범위대로 구현하기 위해서는 몇 가지의 부품과 장비들이 필요합니다.
	1.	**MYO**

		![MYO](http://static4.businessinsider.com/image/53a8718e6bb3f7df2ecda5e3-1200-522/myo-on-arm.jpg "MYO 암 밴드를 착용한 모습")

		*	손의 제스처를 인식하기 위해서 필요한 장비입니다. 팔에 착용한 상태에서 제스처를 취하면 MYO가 인식을 해 이를 이용해서 굉장히 많은 분야에서 사용할 수 있습니다. 게임, 프레젠테이션, 마우스 및 키보드 제어 등에서 사용할 수 있으며, 'Myo Market'에서 사람들이 배포한 앱과 프로그램 등도 굉장히 많습니다.
		*	[MYO 공식 홈페이지](https://www.myo.com/)
	2.	**Raspberry Pi**
		
		![라즈베리파이](http://images.kbench.com:8080/kbench/article/2016_09/k167529p1n1.jpg "라즈베리파이")

		* 라즈베리파이는 현실세계에서 보내준 신호(통신)을 받아 가상세계의 시스템을 제어하는 목적으로 사용됩니다. 실제로 구현할 때는 라즈베리 파이를 이용하여 서보모터를 제어합니다. 라즈베리 파이 세팅법과 서보모터 제어에 관해서는 관련 항목에 기술해 놓았습니다. 모델은 라즈베리파이 B+ 모델입니다.
		* [Raspberry Pi 공식 홈페이지](https://www.raspberrypi.org/)
	3.	**lattepanda**

		![라떼판다](http://v2.lattepanda.com/wp-content/uploads/2017/04/1.jpg "라떼판다")

		*	라떼판다는 MYO로 손의 제스처를 인식하고, 인식 후 가상세계로 신호를 보내주는 역활을 합니다. 즉, 현실세계를 구현하기 위함입니다. 라떼판다는 window OS 기반의 작은 pc라고 생각하시면 될 것 같습니다. 아두이노도 기본적으로 탑재되어있고, 아두이노 GPIO도 가지고 내장되어 있어 가격은 다소 비싸지만 최근 많은 사람들이 프로젝트 등에 사용하고 있습니다. 이 프로젝트에서는 아두이노 GPIO를 사용하지 않았습니다. MYO와 연결하고, 가상세계에 신호를 보내주기위해 사용하였습니다.
		*	[lattepanda 공식 홈페이지](http://www.lattepanda.com/)
	4.	**서보모터** 
		
		![서보모터](https://kocoafab.cc/data/150116021305.jpg "서보모터")
		
		*	가상세계에서는 시스템을 제어하게 되는데 이 프로젝트에서는 간단하게 서보모터를 사용했습니다. 서보모터에 센티널(종이로 인쇄한)을 고정시켜 서보모터를 움직이면 센티널도 움직이는 형태입니다. 서보모터는 일반 모터와 다르게 180도를 회전합니다.(물론 360도를 회전하는 서보모터도 있습니다) 그래서 보통 RC카의 앞 바퀴(방향을 틀기 위한)제어 등에 사용됩니다.
	
	5.	**센티널을 인쇄한 종이**
		*	어쩌면 이 프로젝트에서 가장 중요한(?) 물품일 수도 있겠습니다... 
	

### 방법

*	개발 범위와, 부품 및 장비들이 모두 준비되었습니다. 구현을 하기전에 조금 더 구체적으로 정리해 보자면 다음과 같습니다.
	*	**현실세계에서 손의 제스처(모양)를 인식하고 신호를 보내주는 부분**
		*	손의 제스처는 MYO를 이용해서 인식하도록 할 것 입니다. MYO는 블루투스 동글을 라떼판다에 꽂으면 라떼판다와 MYO가 블루투스 통신을 하게 됩니다. MYO가 손 제스처를 인식하면 PC에 어떠한 데이터 값이 나오는데, 그것을 이용할 것 입니다.
		*	현실세계는 라떼판다를 이용해 구현해 볼 것입니다. 라떼판다는 MYO와 연결이 된 상태입니다. 라떼판다의 역활은 MYO로부터 읽어지는 데이터를 처리하고, 분석해 일정한 조건이 충족 됐다면 가상세게(라즈베리파이)로 신호를 보내주게 됩니다. 여기에서 라떼판다와 라즈베리파이는 서로 같은 와이파이에 연결되어 있으며 소켓 통신을 이용해 서로 통신을 하게 되며, 라떼판다는 클라이언트가 됩니다.
		
	*	**가상세계에서 현실세계에서 보내준 신호를 받고 시스템을 제어하는 부분**
		*	가상세계는 라즈베리파이로 구현할 것 입니다. 라즈베리파이는 라떼판다와 소켓 통신을 하게되며 라떼판다에서 신호(통신)을 보내오면 서보모터를 제어하게 되는 서버 역활을 합니다. 라즈베리파이의 GPIO와 'wiringPi'를 사용하였습니다. wiringPi는 라즈베리파이 GPIO를 아두이노처럼 사용할 수 있게 해주는 라이브러리 입니다. C언어로 코딩을 할 수 있습니다. 물론 파이썬으로도 GPIO를 제어할 수 있고, 그것이 더 쉬울 수 도 있겠지만 소켓 통신을 C언어로 구현하였기 때문에 
		C언어를 사용하였습니다.
		*	서보모터에 센티널(을 인쇄한 종이)을 붙입니다. 라즈베리파이 GPIO를 이용해 서보모터를 제어합니다. 

	 
*	#### **MYO**
	
	*	**MYO Start**
		*	MYO는 개발하기전에 세팅 등을 하셔야 합니다. 위에 첨부한 공식홈페이지 링크에서 프로그램을 다운받고 가이드가 해주는 대로 따라하시면 됩니다. MYO가 잘 인식을 못하거나 잘 안되는 경우도 있습니다. 그럴경우 calibration을 다시 해주시거나 처음부터 start guide를 따라 하시는 것도 방법입니다. 제가 진행했을 때는 팔 두께가 얇은 사람은 인식이 잘 안되는 것 같았습니다.(물론 제 팔 두깨가 두꺼워서 얇은 사람이 했을 때 그런걸지도 모르겠지만요...)
		
	
	*	**MYO Develop**
		*	MYO 공식홈페이지에 **Developer**와 관련된 항목이 있습니다. 홈페이지 링크는 아래에 첨부해 놓았습니다. 이 페이지에서 SDK를 다운받으면 Visual studio 프로젝트 파일들과 소스들이 있습니다. 여기에서 **hello-myo-VisualStudio2013**라는 프로젝트가 있는데, 이프로젝트와 소스들을 이용했습니다. **hello-myo.cpp** 소스파일에 **poseString.size()** 메소드를 사용합니다. 이 메소드는 MYO에서 인식한 손 제스처에 따른 정해진 데이터를 반환해 주는 메소드 입니다. 직접 MYO를 사용하시면서 반환값을 확인해 보시면 좋을 것 같습니다. 
		
		*	장풍은 손을 앞으로 내밀고, 손바닥과 손가락을 피는 제스처 입니다. MYO에서는 장풍과 같은 제스처를 인식하지는 못합니다. 하지만 손바닥과 손가락을 피는 제스처는 인식할 수 있습니다. 그래서 실제로 시연을 할 때도 장풍과 똑같은 제스처를 취해도 인식을 할 수 있습니다. 다만, 손바닥과 손가락을 펴서 MYO가 인식할 수 있게 해줘야 합니다. 
	
		*	**poseString.size()** 반환값에 따라 if문을 작성하였습니다. 반환값은 오른쪽 팔에 착용했을 때 '**9**'는 손가락을 두번 탭 하였을 때 나오고, **13**은 손가락을 모두 폈을 때(손바닥을 폈을 때) 나오는 반환값 입니다. 저는 이 두개의 값을 이용해 장풍 제스처를 인식하도록 하였습니다.
	
		*	하지만 MYO의 특성상(센서의 특성상 이라고 해야할까요?)값을 잘못 인식하는, 튀는 경우가 종종 있습니다. 저는 이것을 방지하기 위해 **안정장치**를 마련했습니다. 장풍을 하기전에 다른 제스처를 먼저 취하는 것 이지요. 저는 이것을 손가락을 두번 탭하는 것으로 문제점을 방지하였습니다. 
	

	
*	#### **lattepanda**

	*	**Lattepanda Start** 
		*	라떼판다는 기본적으로 window os가 설치되어 있습니다. 우리가 PC를 쓰듯 모니터와 키보드, 마우스를 연결하고 사용하시면 됩니다. 라떼판다 64GB모델의 경우에도 window 10이 설치되어 있지만 정품 인정을 받아야합니다. 자세한 설명과 가이드는 아래 링크를 참조하시면 될 것 같습니다.   
		*	[라떼판다 Start 가이드](http://docs.lattepanda.com/content/getStarted/powerOn/)
	
	*	**Lattepanda Develop**
		*	라떼판다와 라즈베리파이간의 소켓 통신에서 라떼판다는 클라이언트 입니다. 장풍 제스처를 취했을 때 라떼판다는 라즈베리파이(서버)에게 접속 요청을 보냅니다. 라떼판다와 라즈베리파이는 모두 같은 와이파이에 연결이 되어 있어야 합니다. 라떼판다 내에서는 **Visual Studio(VS)**를 이용해 프로그래밍 하였습니다(MYo코드와 소켓 통신 코드 모두 C언어, VS를 사용하였습니다.)
	
		*	소켓통신의 경우 윈도우 기반의 소켓관련 함수들을 사용하여 프로그래밍 하였습니다. 기본적인 윈도우 기반의 소켓 프로그래밍은 인터넷에 굉장히 많은 예제들이 나와있어 그것을 기본적으로 사용하였습니다. 
		
		*	윈도우 소켓 프로그래밍의 경우 쓰레드를 사용하여 서버와 클라이언트간의 통신을 하게 되는데, 쓰레드를 사용해서 통신을 했을 때 MYO의 데이터를 가져와 처리하는 부분에서 문제가 생겼습니다. 두 코드 모두 제가 직접 코딩을 안했기 때문에 그런 문제가 발생한 것 같았습니다. 그래서 저는 어쩔 수 없이 쓰레드를 사용해서 통신을 하기보다는 클라이언트가 서버에 접속 요청을 하고, 서버가 허용하면 신호가 온 것으로 처리를 했습니다. 
			
*	#### **Raspberry Pi**
		
	*	**Raspberry Pi OS 설치**		
		*	라즈베리파이는 영국 라즈베리 파이(Raspberry Pi)재단에서 만든 초소형 PC입니다. 가격도 라떼판다에 비해서는 싼 가격을 이루고 있습니다. 최근에 나온 라즈베리파이 3 모델의 경우 4~5만원 정도를 하니까 일반인들도 싼 가격으로 이용할 수 있습니다. 라즈베리파이의 경우 os가 기본적으로 설치되어 있지 않습니다. 그렇기 때문에 Os를 직접 설치하시고, 필요한 것들을 세팅하셔야 합니다. 

		*	라즈베리파이 os는 [라즈베리파이 OS Download](https://www.raspberrypi.org/downloads/) 에 들어가시면 os을 다운 받으실 수 있습니다. 일반적으로 **NOOBS**와 **RASPBIAN**을 사용합니다. **NOOBS**는 여러가지 OS를 함께 내장하고 있어 처음 라즈베리파이를 사용하는 사람들에게는 괜찮은 선택입니다(여러가지 OS를 사용할 수 있습니다). **RASPBIAN**은 라즈베리파이용 OS로 **데비안 리눅스**를 기반으로 만들어진 배포판입니다.(그냥 라즈베리파이에 최적화된 리눅스 라고 생각하셔도 될 것 같습니다.) 보통의 경우 라즈베리파이에 **RASPBIAN**을 설치하고 사용합니다. 저는 **RASPBIAN**을 설치하였습니다.

		*	라즈비안을 설치하는 방법은 굉장히 쉽습니다. 다운로드 홈페이지에서 OS를 다운받은 후 라즈베리파이에 넣을 SD카드에 write를 해줍니다. 그리고 sd카드를 라즈베리파이에 끼운 후 라즈베리파이를 부팅시키면 끝 입니다. 그리고 라즈베리파이와 모니터를 연결할 때는 전원을 키기 전에 연결하여야 합니다. 만약 전원을 키고 연결을 하면 안되는 경우도 있을 수 있습니다.(저는 항상 그래서 모니터와 먼저 연결하고 전원을 켰습니다) 

		*	윈도우에서 sd카드에 iso(디스크 이미지)파일을 write해주려면 프로그램이 필요합니다. 저는 **Win32 Disk Imager**를 사용하였습니다. [다운로드 링크](https://sourceforge.net/projects/win32diskimager/files/latest/download)를 첨부해 놓겠습니다.

	*	**Raspberry Pi 개발환경 설치 및 세팅**
			
		*	라즈베리파이의 라즈비안 os는 리눅스환경 입니다. 리눅스를 기본적으로 사용해보거나, 리눅스 환경에서 개발하신 분이라면 이쪽 부분은 안보셔도 될 것 같습니다. 저는 vim을 사용해서 개발했습니다. 'sudo apt-get install vim'명령어를 사용하여 설치할 수 있습니다. 그외 vimrc등의 설정은 인터넷에 찾아보시면 관련된 자료들이 많이 나와 있습니다. 
			
		*	라즈베리파이에서 개발할 때는 두가지 정도의 방법이 있습니다. 하나는 모니터를 사용해서 PC처럼 개발하는 방법과 SSH를 이용하는 방법입니다. 각각의 장단점은 다 있습니다. 하지만 보통 리눅스 터미널에서 개발하는 라즈베리파이의 경우 SSH를 이용한 개발이 더 편할 수도 있습니다. SSH를 이용하면 랜선 만으로도 라즈베리파이를 접속할 수 있습니다. 그럼 모니터가 필요 없겠죠? 물론 무선 와이파이를 이용해서 접속할 수 도 있지만 속도가 느린걸로 알고 있습니다. 라즈베리파이 SSH관련 세팅 및 설정은 [링크](http://mechasolutionwiki.com/index.php?title=SSH%EB%A5%BC_%ED%86%B5%ED%95%9C_%EB%9D%BC%EC%A6%88%EB%B2%A0%EB%A6%AC%ED%8C%8C%EC%9D%B4_%EC%9B%90%EA%B2%A9%EC%A0%9C%EC%96%B4)를 참고하시면 될 것 같습니다.  		

		*	그 외의 키보드, 와이파이, 국가, 언어 등의 설정은 인터넷에서 찾아보면서 하시는 것이 좋을 것 같습니다. 

	*	**Raspberry Pi Develop**
		
		*	라즈베리파이는 서버의 역할을 합니다. 리눅스의 소켓 통신 관련 함수들을 사용해서 구현을 하였습니다. 라즈베리파이는 서버이므로 라떼판다(클라이언트)에서 오는 접속 요청을 받게됩니다. 클라이언트는 장풍 제스처를 취했을 때 서버로부터 소켓 접속 요청을 보내는 것 이므로, 서버에서 이를 받으면 현실세계로부터 오는 신호(장풍 제스처를 했다는)를 받게 되는 것 입니다. 즉 서버에서는 클라이언트의 접속 요청을 받게되는 것이 현실세계에서 가상세계로 신호가 오는 것이지요. 그리고 서버에서는 요청을 받고 서보모터를 제어하게 됩니다.

		*	라즈베리파이에서는 GPIO를 이용하여 여러 부품 등을 제어하거나, 센서등의 값을 읽어들일 수 있습니다. 여기에서는 GPIO를 이용하여 서보모터를 제어하겠습니다. 다행히도 GPIO를 쉽게 제어할 수 있게 해주는 라이브러리가 있습니다. **wiringPi**를 사용하면 아두이노에서 코딩하듯이 같은 문법을 사용하여 라즈베리파이의 GPIO를 사용할 수 있습니다. 관련된 자세한 정보와 라이브러리 다운은 [wiringPi 홈페이지](http://wiringpi.com/) 에서 참고해 보시면 될 것 같습니다.

		*	라즈베리파이에서 서보모터를 제어하는 예제 코드 등은 인터넷에서 많이 찾아보실 수 있습니다. 여기에서는 PWM제어를 통해서 서보모터를 제어하였습니다. 라즈베리파이의 GPIO를 wiringPi를 이용하여 제어할 때는 GPIO의 핀 번호와 wiringPi의 핀 번호를 잘 봐야 합니다. 즉 물리적으로 되어있는 핀과 실제 코딩 했을 때 쓰여지는 핀의 번호가 다르기 때문에 이를 잘 보고 프로그래밍 해야합니다. 	


### 결과


* '매트릭스'에서 주인공이 현실세계에서 가상세계의 괴물들을 공격하는	장면을 실제로 구현해보았습니다. 고작 라즈베라파이와 라떼판다를 가지고 통신을 한 것이 왜 가상세계고, 현실세계냐 라고 생각하시는 분들도 계시겠지만 의미부여를 하는것이 굉장히 중요하고, 또 물리적으로 떨어져있는 하드웨어들을 통신으로 연결하는 것도 비슷한 의미이지 않을까 생각합니다.

* 결과적으로 MYO에서는 장풍 제스처를 성공적으로 인식했고, 라떼판다에서는 라즈베리파이에게 소켓통신을 이용하여 값을 전달해 주었습니다. 그리고 라즈베리파이는 서보모터를 정상적으로 작동하였습니다. 즉 프로젝트는 성공적으로 마무리되었습니다. 
	
* MYO를 가지고 할 수 있는게 할 수 있는게 굉장히 많다는 것을 느꼈습니다. 손 제스처를 인식할때는 손 제스처의 값만을 가지고 개발을 했지만, MYO가 센싱하고 있는 근전도센서, 자이로센서, 방향센서 등의 값도 얻을 수 있었습니다. MYO에서 센싱하는 다양한 센서값들을 이용해 여러가지 재미있는 것들을 많이 만들어볼 수 있을 것 같습니다. 저는 현재 인스페이스 김태영 CTO님과 'MYO GAN'을 진행하고자 합니다. 

* 최종사진과 비디오는 github에 올려두었습니다. [Github 링크](https://github.com/jigeria/myo_gan/tree/master/myo_jangpung)

